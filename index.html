import React, { useState, useEffect, useRef } from 'react';
import { Send, Bot, User, Loader2, AlertCircle, Heart, Brain, Activity, TrendingUp, BarChart3, Sparkles, CheckCircle } from 'lucide-react';

const HealthChatbot = () => {
  const [messages, setMessages] = useState([]);
  const [input, setInput] = useState('');
  const [isLoading, setIsLoading] = useState(false);
  const [userProfile, setUserProfile] = useState(null);
  const [showOnboarding, setShowOnboarding] = useState(true);
  const [onboardingStep, setOnboardingStep] = useState(0);
  const [interventionCount, setInterventionCount] = useState(0);
  const [rewardScore, setRewardScore] = useState(0);
  const messagesEndRef = useRef(null);

  const onboardingQuestions = [
    {
      question: "Welcome to the RL-Based Health Intervention System! ü§ñ\n\nThis chatbot uses Reinforcement Learning to learn from your responses and continuously improve personalized health recommendations.\n\nWhat's your name?",
      field: "name",
      type: "text"
    },
    {
      question: "Hi {name}! What's your age?",
      field: "age",
      type: "number"
    },
    {
      question: "What's your gender?",
      field: "gender",
      type: "select",
      options: ["Male", "Female", "Non-binary", "Prefer not to say"]
    },
    {
      question: "Which health areas concern you most? (Select all that apply)\n\n1. Mental health (stress, anxiety, depression)\n2. Physical health (illness, pain, fatigue)\n3. Lifestyle (diet, exercise, sleep)\n4. Substance use (smoking, alcohol)\n5. Academic stress\n\nType numbers separated by commas (e.g., 1,3,5)",
      field: "concerns",
      type: "multiselect",
      options: ["mental", "physical", "lifestyle", "substance", "academic"]
    },
    {
      question: "On a scale of 1-10, how would you rate your current overall health?",
      field: "healthRating",
      type: "number"
    },
    {
      question: "How often do you experience stress or anxiety?\n\n1. Rarely\n2. Sometimes\n3. Often\n4. Very often\n5. Almost always",
      field: "stressLevel",
      type: "select",
      options: ["Rarely", "Sometimes", "Often", "Very often", "Almost always"]
    }
  ];

  useEffect(() => {
    messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });
  }, [messages]);

  const calculateReward = (userResponse, interventionType) => {
    // Simulated RL reward calculation
    let reward = 0;
    
    if (userResponse.toLowerCase().includes('better') || 
        userResponse.toLowerCase().includes('helped') ||
        userResponse.toLowerCase().includes('good')) {
      reward += 10;
    }
    
    if (userResponse.length > 50) reward += 5; // Engaged response
    
    return reward;
  };

  const getRLState = (profile, conversationHistory) => {
    // Create state representation for RL
    return {
      concerns: profile?.concerns || [],
      stressLevel: profile?.stressLevel || 0,
      healthRating: profile?.healthRating || 5,
      interventionHistory: interventionCount,
      engagementLevel: conversationHistory.length,
      recentTopic: conversationHistory[conversationHistory.length - 1]?.concernType || 'general'
    };
  };

  const selectRLAction = (state) => {
    // RL policy for selecting intervention type
    const actions = [
      { type: 'psychoeducation', priority: 0 },
      { type: 'behavioral', priority: 0 },
      { type: 'cognitive', priority: 0 },
      { type: 'referral', priority: 0 }
    ];

    // Adjust priorities based on state
    if (state.concerns.includes('mental')) {
      actions.find(a => a.type === 'cognitive').priority += 3;
    }
    if (state.concerns.includes('lifestyle')) {
      actions.find(a => a.type === 'behavioral').priority += 3;
    }
    if (state.healthRating < 4) {
      actions.find(a => a.type === 'referral').priority += 2;
    }
    if (state.interventionHistory < 3) {
      actions.find(a => a.type === 'psychoeducation').priority += 2;
    }

    // Select action with highest priority (with some randomness)
    actions.forEach(a => a.priority += Math.random());
    return actions.sort((a, b) => b.priority - a.priority)[0].type;
  };

  const handleOnboardingResponse = (response) => {
    const currentQ = onboardingQuestions[onboardingStep];
    
    setUserProfile(prev => ({
      ...prev,
      [currentQ.field]: currentQ.type === 'multiselect' 
        ? response.split(',').map(n => currentQ.options[parseInt(n.trim()) - 1]).filter(Boolean)
        : response
    }));

    const botMessage = {
      role: 'assistant',
      content: response,
      timestamp: new Date(),
      isOnboarding: true
    };
    
    setMessages(prev => [...prev, botMessage]);

    if (onboardingStep < onboardingQuestions.length - 1) {
      setOnboardingStep(prev => prev + 1);
      setTimeout(() => {
        let nextQuestion = onboardingQuestions[onboardingStep + 1].question;
        if (nextQuestion.includes('{name}')) {
          nextQuestion = nextQuestion.replace('{name}', response);
        }
        setMessages(prev => [...prev, {
          role: 'assistant',
          content: nextQuestion,
          timestamp: new Date(),
          isOnboarding: true
        }]);
      }, 500);
    } else {
      setShowOnboarding(false);
      setTimeout(() => {
        setMessages(prev => [...prev, {
          role: 'assistant',
          content: `‚úÖ Profile Complete!\n\nüéØ **RL System Initialized**\n\nYour personalized health profile has been created. My Reinforcement Learning algorithm will now:\n\n‚Ä¢ **Learn** from your responses and feedback\n‚Ä¢ **Adapt** interventions based on what works best for you\n‚Ä¢ **Optimize** recommendations using reward signals\n‚Ä¢ **Track** your progress over time\n\nI've identified your main concerns as: ${(userProfile?.concerns || []).join(', ')}\n\nHow can I support you today?`,
          timestamp: new Date(),
          concernType: 'system'
        }]);
      }, 500);
    }
  };

  const generateRLResponse = async (userMessage, conversationHistory) => {
    // Crisis detection
    if (/suicide|kill myself|want to die|end it all/i.test(userMessage)) {
      return {
        content: "üö® **URGENT: Crisis Detected**\n\nI'm very concerned about what you're sharing. Please reach out for immediate help:\n\n**Emergency Services:**\n‚Ä¢ Emergency: 999\n‚Ä¢ Kaan Pete Roi: 1060 (24/7)\n‚Ä¢ National Mental Health: 16263\n\n**Campus Resources:**\n‚Ä¢ University Health Center\n‚Ä¢ Counseling Services\n\nYour life matters. Please contact one of these services right now.",
        concernType: 'urgent',
        interventionType: 'crisis',
        reward: 0
      };
    }

    // Get RL state and select action
    const state = getRLState(userProfile, conversationHistory);
    const actionType = selectRLAction(state);

    // Analyze user concerns
    const concerns = {
      mental: /stress|anxiety|depress|worry|sad|mood|overwhelm/i.test(userMessage),
      physical: /pain|sick|fever|tired|fatigue|headache/i.test(userMessage),
      lifestyle: /diet|exercise|sleep|eat|weight|study/i.test(userMessage),
      academic: /exam|study|assignment|grade|deadline/i.test(userMessage)
    };

    const concernType = Object.keys(concerns).find(k => concerns[k]) || 'general';

    // Build RL-aware prompt
    const systemPrompt = `You are an RL-based health intervention chatbot for university students. You continuously learn and optimize interventions.

**User Profile:**
- Name: ${userProfile?.name}
- Concerns: ${userProfile?.concerns?.join(', ')}
- Stress Level: ${userProfile?.stressLevel}
- Health Rating: ${userProfile?.healthRating}/10

**Current RL State:**
- Intervention Count: ${interventionCount}
- Reward Score: ${rewardScore}
- Selected Action: ${actionType}

**Action Types:**
- psychoeducation: Explain condition, provide information
- behavioral: Specific action steps, lifestyle changes
- cognitive: Thought patterns, coping strategies
- referral: Suggest professional help

Provide a ${actionType} intervention for: ${concernType}

Guidelines:
- Reference their profile naturally
- Provide 3-4 actionable steps
- Ask for feedback to improve learning
- Be empathetic and personalized
- Keep response 2-3 paragraphs`;

    try {
      const response = await fetch('https://api.anthropic.com/v1/messages', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          model: 'claude-sonnet-4-20250514',
          max_tokens: 1000,
          messages: [
            {
              role: 'user',
              content: `${systemPrompt}\n\nUser message: ${userMessage}\n\nProvide personalized ${actionType} intervention.`
            }
          ]
        })
      });

      const data = await response.json();
      const assistantResponse = data.content
        .filter(block => block.type === 'text')
        .map(block => block.text)
        .join('\n');

      return {
        content: `**ü§ñ RL Intervention (${actionType})**\n\n${assistantResponse}\n\n---\n*Was this helpful? Your feedback helps me learn and improve! (Type 'yes' or provide feedback)*`,
        concernType,
        interventionType: actionType,
        reward: 0
      };
    } catch (error) {
      console.error('API Error:', error);
      return {
        content: `**ü§ñ RL Intervention (${actionType})**\n\nBased on your profile, here are personalized recommendations:\n\n1. **Immediate Action**: Take 5 deep breaths - inhale for 4, hold for 4, exhale for 4\n2. **Short-term**: Schedule 20 minutes today for an activity you enjoy\n3. **Long-term**: Consider speaking with campus counseling services\n\nWas this helpful? Your feedback helps me learn!`,
        concernType,
        interventionType: actionType,
        reward: 0
      };
    }
  };

  const handleSend = async () => {
    if (!input.trim() || isLoading) return;

    const userMessage = {
      role: 'user',
      content: input.trim(),
      timestamp: new Date()
    };

    setMessages(prev => [...prev, userMessage]);
    const currentInput = input.trim();
    setInput('');

    if (showOnboarding) {
      handleOnboardingResponse(currentInput);
      return;
    }

    setIsLoading(true);

    try {
      const response = await generateRLResponse(currentInput, messages);
      
      // Calculate reward from user response
      const reward = calculateReward(currentInput, response.interventionType);
      setRewardScore(prev => prev + reward);
      setInterventionCount(prev => prev + 1);

      const assistantMessage = {
        role: 'assistant',
        content: response.content,
        timestamp: new Date(),
        concernType: response.concernType,
        interventionType: response.interventionType
      };

      setMessages(prev => [...prev, assistantMessage]);
    } catch (error) {
      console.error('Error:', error);
    } finally {
      setIsLoading(false);
    }
  };

  const getInterventionIcon = (type) => {
    switch(type) {
      case 'psychoeducation': return <Brain className="w-4 h-4" />;
      case 'behavioral': return <Activity className="w-4 h-4" />;
      case 'cognitive': return <Heart className="w-4 h-4" />;
      case 'referral': return <AlertCircle className="w-4 h-4" />;
      case 'crisis': return <AlertCircle className="w-4 h-4 text-red-500" />;
      default: return <Sparkles className="w-4 h-4" />;
    }
  };

  return (
    <div className="flex flex-col h-screen bg-gradient-to-br from-indigo-50 via-purple-50 to-pink-50">
      {/* Header */}
      <div className="bg-white border-b shadow-md">
        <div className="max-w-4xl mx-auto px-4 py-3">
          <div className="flex items-center justify-between">
            <div className="flex items-center gap-3">
              <div className="w-12 h-12 bg-gradient-to-br from-indigo-600 via-purple-600 to-pink-600 rounded-xl flex items-center justify-center shadow-lg">
                <Bot className="w-7 h-7 text-white" />
              </div>
              <div>
                <div className="flex items-center gap-2">
                  <h1 className="text-xl font-bold bg-gradient-to-r from-indigo-600 to-purple-600 bg-clip-text text-transparent">
                    RL-Based Health AI
                  </h1>
                  <span className="px-2 py-0.5 bg-gradient-to-r from-indigo-500 to-purple-500 text-white text-xs rounded-full font-semibold">
                    LEARNING
                  </span>
                </div>
                <p className="text-xs text-gray-600">Reinforcement Learning ‚Ä¢ Personalized Interventions</p>
              </div>
            </div>
            {!showOnboarding && (
              <div className="flex gap-3 text-center">
                <div className="px-3 py-1 bg-indigo-50 rounded-lg">
                  <div className="text-xs text-gray-500">Interventions</div>
                  <div className="text-sm font-bold text-indigo-600">{interventionCount}</div>
                </div>
                <div className="px-3 py-1 bg-purple-50 rounded-lg">
                  <div className="text-xs text-gray-500">RL Score</div>
                  <div className="text-sm font-bold text-purple-600">{rewardScore}</div>
                </div>
              </div>
            )}
          </div>
        </div>
      </div>

      {/* RL System Status */}
      {!showOnboarding && userProfile && (
        <div className="bg-gradient-to-r from-indigo-500 to-purple-600 text-white px-4 py-2">
          <div className="max-w-4xl mx-auto flex items-center justify-between text-sm">
            <div className="flex items-center gap-2">
              <TrendingUp className="w-4 h-4" />
              <span>Profile: {userProfile.name} ‚Ä¢ Health: {userProfile.healthRating}/10</span>
            </div>
            <div className="flex items-center gap-2">
              <BarChart3 className="w-4 h-4" />
              <span>System adapting to your needs...</span>
            </div>
          </div>
        </div>
      )}

      {/* Chat Messages */}
      <div className="flex-1 overflow-y-auto px-4 py-6">
        <div className="max-w-3xl mx-auto space-y-4">
          {messages.length === 0 && (
            <div className="flex items-center justify-center h-full">
              <div className="text-center space-y-4 p-8">
                <div className="w-20 h-20 bg-gradient-to-br from-indigo-600 to-purple-600 rounded-full flex items-center justify-center mx-auto shadow-xl">
                  <Sparkles className="w-10 h-10 text-white" />
                </div>
                <h2 className="text-2xl font-bold text-gray-800">Welcome to RL-Based Health AI</h2>
                <p className="text-gray-600 max-w-md">
                  This system uses <strong>Reinforcement Learning</strong> to continuously learn from your interactions
                  and provide increasingly personalized health interventions.
                </p>
                <button
                  onClick={() => {
                    setMessages([{
                      role: 'assistant',
                      content: onboardingQuestions[0].question,
                      timestamp: new Date(),
                      isOnboarding: true
                    }]);
                  }}
                  className="px-6 py-3 bg-gradient-to-r from-indigo-600 to-purple-600 text-white rounded-full font-semibold hover:shadow-lg transition"
                >
                  Start Onboarding
                </button>
              </div>
            </div>
          )}

          {messages.map((message, index) => (
            <div
              key={index}
              className={`flex gap-3 ${message.role === 'user' ? 'flex-row-reverse' : 'flex-row'}`}
            >
              <div className={`w-10 h-10 rounded-full flex items-center justify-center flex-shrink-0 shadow-lg ${
                message.role === 'user' 
                  ? 'bg-gradient-to-br from-pink-500 to-rose-600' 
                  : 'bg-gradient-to-br from-indigo-600 to-purple-600'
              }`}>
                {message.role === 'user' ? (
                  <User className="w-5 h-5 text-white" />
                ) : (
                  <Bot className="w-5 h-5 text-white" />
                )}
              </div>
              <div className={`flex-1 ${message.role === 'user' ? 'flex justify-end' : ''}`}>
                <div className={`inline-block max-w-[85%] rounded-2xl px-5 py-3 shadow-md ${
                  message.role === 'user'
                    ? 'bg-gradient-to-br from-pink-500 to-rose-600 text-white'
                    : 'bg-white border-2 border-gray-100'
                }`}>
                  {message.interventionType && message.role === 'assistant' && (
                    <div className="flex items-center gap-2 mb-2 pb-2 border-b border-gray-200">
                      {getInterventionIcon(message.interventionType)}
                      <span className="text-xs font-semibold text-indigo-600 uppercase">
                        {message.interventionType} Intervention
                      </span>
                    </div>
                  )}
                  <p className="text-sm whitespace-pre-line leading-relaxed">
                    {message.content}
                  </p>
                  <p className={`text-xs mt-2 ${message.role === 'user' ? 'opacity-70' : 'text-gray-400'}`}>
                    {message.timestamp.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}
                  </p>
                </div>
              </div>
            </div>
          ))}
          {isLoading && (
            <div className="flex gap-3">
              <div className="w-10 h-10 rounded-full bg-gradient-to-br from-indigo-600 to-purple-600 flex items-center justify-center shadow-lg">
                <Bot className="w-5 h-5 text-white" />
              </div>
              <div className="bg-white border-2 border-gray-100 shadow-md rounded-2xl px-5 py-3">
                <div className="flex items-center gap-2">
                  <Loader2 className="w-4 h-4 animate-spin text-indigo-600" />
                  <span className="text-sm text-gray-600">RL system processing...</span>
                </div>
              </div>
            </div>
          )}
          <div ref={messagesEndRef} />
        </div>
      </div>

      {/* Input Area */}
      <div className="border-t bg-white shadow-lg">
        <div className="max-w-3xl mx-auto px-4 py-4">
          <div className="flex gap-2">
            <input
              type="text"
              value={input}
              onChange={(e) => setInput(e.target.value)}
              onKeyPress={(e) => e.key === 'Enter' && handleSend()}
              placeholder={showOnboarding ? "Type your answer..." : "Share your concerns or ask for help..."}
              className="flex-1 px-5 py-3 border-2 border-gray-200 rounded-full focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent"
              disabled={isLoading}
            />
            <button
              onClick={handleSend}
              disabled={isLoading || !input.trim()}
              className="px-6 py-3 bg-gradient-to-r from-indigo-600 to-purple-600 text-white rounded-full hover:shadow-xl transition disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2 font-semibold"
            >
              {isLoading ? (
                <Loader2 className="w-5 h-5 animate-spin" />
              ) : (
                <Send className="w-5 h-5" />
              )}
            </button>
          </div>
          <div className="flex items-center justify-center gap-4 mt-3 text-xs text-gray-500">
            <span>üîí Confidential & Anonymous</span>
            <span>‚Ä¢</span>
            <span>üß† AI learns from your feedback</span>
            <span>‚Ä¢</span>
            <span>‚ö†Ô∏è Emergency: 999</span>
          </div>
        </div>
      </div>
    </div>
  );
};

export default HealthChatbot;
